<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">
        <title>Pinegrow | Bootstrap Blocks Template</title>
        <!-- Bootstrap core CSS -->
        <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <!--<script src="../scripts/csi.min.js"></script>-->
        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" rel="stylesheet">-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.bundle.min.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alfa+Slab+One&display=swap">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alice&display=swap">
        <link rel="stylesheet" href="../css/blocks.css">
        <link rel="stylesheet" href="../blocks.css">
        <!-- Custom styles for this template -->
        <link href="../css/style.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/lock.css">
    </head>
    <body class="text-secondary">
        <nav class="bg-light navbar navbar-custo navbar-custom navbar-expand-lg navbar-light">
            <a class="navbar-brand" href="index.html" style="font-family: 'Alfa Slab One', cursive; font-size: 26px; color: #e7822c; letter-spacing: 1px;">VolunTier</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggler30" aria-controls="" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarToggler30">
                <ul class="navbar-nav mr-auto mt-2 mt-lg-0" id="appTab"></ul>
            </div>
            <a style="font-family: 'Alice', serif; font-size: 15px; color: #000000; letter-spacing: 1px; text-align: center;" id="user_tag"></a>
        </nav>

        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'Map')" id="defaultOpen">Map</button>
            <button class="tablinks" onclick="openTab(event, 'Profile')">Profile</button>
            <button class="tablinks" onclick="openTab(event, 'EmptyTab1')">EmptyTab</button>
            <button class="tablinks" onclick="openTab(event, 'EmptyTab2')">EmptyTab</button>
        </div>
        <!-- Tab contents-->
        <div id="Map" class="tabcontent">
            <span onclick="this.parentElement.style.display='none'" class="topright">&times</span>
            <main class="app">
                <aside class="sidebar" style="background-color:white;">
                    <ul>
                        <li>This right here is your panel</li>
                        <li>(In development)</li>
                    </ul>
                </aside>
                <section class="map-area " id="map">
                    <!-- Async script executes immediately and must be after any DOM elements used in callback. -->
                    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCxgVR80ZfBsHQjmUlAJVsHrEZRP4Irk50&callback=initMap&libraries=&v=weekly" async></script>
                </section>
            </main>
        </div>
        <div id="Profile" class="tabcontent">
            <span onclick="this.parentElement.style.display='none'" class="topright">&times</span>
            <div data-include="./contents/profile.html"></div>
        </div>
        <div id="EmptyTab1" class="tabcontent">
            <span onclick="this.parentElement.style.display='none'" class="topright">&times</span>
            <h3>EmptyTab1</h3>
            <p>Nothing but void.</p>
        </div>
        <div id="EmptyTab2" class="tabcontent">
            <span onclick="this.parentElement.style.display='none'" class="topright">&times</span>
            <h3>EmptyTab2</h3>
            <p>Nothing but void.</p>
        </div>
        <footer class="bg-dark pt-5 text-white-50">
            <div class="container">
                <div class="row">
                </div>
            </div>
        </footer>
        <script src="../assets/js/jquery.min.js"></script>
        <script src="../assets/js/popper.js"></script>
        <script src="../bootstrap/js/bootstrap.min.js"></script>
        <script src="../scripts/formLoader.js"></script>
        <!-- Hash function -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha512/0.8.0/sha512.min.js"></script>
        <script src="../scripts/login.js"></script>
        <script src="../scripts/register.js"></script>
        <script src="../scripts/login_ok_fields.js"></script>
        <script src="../scripts/register_ok_fields.js"></script>
        <script src="../scripts/authenticate.js"></script>
        <script src="../scripts/loadMap.js"></script>
        <script src="../scripts/logout.js"></script>
        <script src="../scripts/csi.min.js"></script>
        <!-- Gotta put this in a separate file-->
        <!-- Load the page with the user info-->
        <script>



            window.onload = function () {
                // For debugging purposes: loadContents();
                if (!tryAuthentication()) {
                    loadContent("appTab", "../pages/contents/logoutTab.html");
                    //window.location = "../pages/index.html";
                    return false;
                }
                loadContents();
                loadContent("appTab", "../pages/contents/loggedTab.html");

                



                var urlvariable = "/rest/user";
                var URL = "https://voluntier-317915.appspot.com" + urlvariable;  //LookUp REST URL
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.open("POST", URL, false);
                xmlhttp.setRequestHeader("Content-Type", "application/json");
                var userId = localStorage.getItem("email"), token = localStorage.getItem("jwt");
                var ItemJSON = '{"email": "' + userId + '", "token": "' + token + '"}';
                xmlhttp.send(ItemJSON);

                if (!(xmlhttp.readyState == 4 && xmlhttp.status == 200))
                    return false;

                /*
                 * Do token refresh or logout if it fails*/


                //Get the content from the json response and fill in the spots with the correct info
                const obj = JSON.parse(xmlhttp.responseText);
                $.ajax({
                    //We need to wait fror the page to load before changing any fields.
                    complete: function () {
                        document.getElementById("profile_username").innerHTML = obj.username;
                        document.getElementById("user_tag").innerHTML = obj.username;
                        document.getElementById("profile_fullname").innerHTML = obj.full_name;
                        document.getElementById("profile_visibility").innerHTML = obj.profile;
                        if (obj.region)
                            document.getElementById("profile_region").innerHTML = obj.region;
                        document.getElementById("profile_email").innerHTML = obj.email;
                        if (obj.address)
                            document.getElementById("profile_address").innerHTML = obj.address;
                        if (obj.mobile)
                            document.getElementById("profile_mobile").innerHTML = obj.mobile;




                    }
                });





            }
        </script>



        <script>
            function openTab(evt, tab) {
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tabcontent");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.getElementsByClassName("tablinks");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                document.getElementById(tab).style.display = "block";
                evt.currentTarget.className += " active";
            }

            // Get the element with id="defaultOpen" and click on it
            document.getElementById("defaultOpen").click();
        </script>
        <script>

            //Content on = true, off = false

            function editBtn() {
                console.log("Now hiding edit button and showing save button");
                //needs to turn the content editable on
                turnContent(true);
                profileBtnSwap();
            }

            function saveBtn() {
                console.log("Now hiding save button and showing edit button");
                //needs to send request to server to save new element values
                //needs to turn the content editable off
                
                turnContent(false);
                saveInfo();
                profileBtnSwap();
            }



            function profileBtnSwap() {
                var x = document.getElementById("editBtn");
                var y = document.getElementById("saveBtn");
                if (x.style.display === "none") {
                    x.style.display = "block";
                    y.style.display = "none";
                } else {
                    x.style.display = "none";
                    y.style.display = "block";
                }
            }

            var profileVisibility = false;

            function turnContent(on) {
                if (on) {
                    $('#profileContainer .editable').each(function () {
                        // console.log($(this.value));
                        $(this).attr("contenteditable", "true");
                    });

                    var profile = document.getElementById("profile_visibility").innerHTML;
                    console.log(profile);
                    var data = 'Profile visibility: <pan class="lock" style = "margin-left:10px" ></span>'
                    $('#profile_visibility').html(data);
                    if (profile == "PUBLIC") {
                        $(".lock").toggleClass('unlocked');
                        profileVisibility = true;
                    }
                    $(".lock").click(function () {
                        $(this).toggleClass('unlocked');
                        profileVisibility = !profileVisibility;
                    });
                    console.log(profileVisibility);

                    var prevRegion = document.getElementById("profile_region").innerHTML;
                    console.log(prevRegion);
                    $.get("contents/profile_region_list.html", function (data) {
                        $('#profile_region_div').html(data);
                        // alert("Load was performed.");
                    });
                    if (prevRegion != "Country") {
                        $.ajax({
                            //We need to wait fror the page to load before changing any fields.
                            complete: function () {
                                $('[name="country"]').val(prevRegion);
                                $('[name="country"]').attr("placeholder", prevRegion);
                            }
                        });
                    }
                }
                else {
                    $('#profileContainer .editable').each(function () {
                        //console.log($(this.value));
                        $(this).attr("contenteditable", "false");
                    });

                    var profile = document.getElementById("profile_visibility");
                    var data;
                    if (profileVisibility)
                        data = "PUBLIC";
                    else
                        data = "PRIVATE";

                    $('#profile_visibility').html(data);
                    console.log(profileVisibility);

                    var prevRegion = $('[name="country"]').val();
                    if (prevRegion == '') prevRegion = $('[name="country"]').attr("placeholder");
                    console.log(prevRegion);
                    var data = '<p class="text-muted font-size-sm editable" id="profile_region">' + prevRegion + '</p>';
                    $('#profile_region_div').html(data);

                }
                return false;
            }




            function saveInfo() {
                var urlvariable = "/rest/update/profile";
                var URL = "https://voluntier-317915.appspot.com" + urlvariable;  //LookUp REST URL
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.open("POST", URL, false);
                xmlhttp.setRequestHeader("Content-Type", "application/json");
                var userId = localStorage.getItem("email"), token = localStorage.getItem("jwt");

                var ItemJSON = '{"email": "' + userId +
                    '", "token": "' + token +
                    '", "full_name": "' + document.getElementById("profile_fullname").innerHTML +
                    '", "profile": "' + document.getElementById("profile_visibility").innerHTML +
                    '", "landline": "' + document.getElementById("profile_landline").innerHTML +
                    '", "mobile": "' + document.getElementById("profile_mobile").innerHTML +
                    '", "address": "' + document.getElementById("profile_address").innerHTML +
                    //'", "address2": "' + address2 +
                    '", "region": "' + document.getElementById("profile_region").innerHTML +
                    //'", "pc": "' + pc +
                    //'", "website": "' + website +
                    //'", "facebook": "' + facebook +
                    //'", "instagram": "' + instagram +
                    //'", "twitter": "' + twitter +
                    '"}';
                console.log(ItemJSON);
                xmlhttp.send(ItemJSON);

                if (!(xmlhttp.readyState == 4 && xmlhttp.status == 200))
                    return false;

                /*
                 * Do token refresh or logout if it fails*/



            }


        </script>
    </body>
</html>
